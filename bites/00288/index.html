<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.22.1/mapbox-gl.js'></script>
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
    <script src="//api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        #range {
      position: absolute;
      bottom: 10px;
      /*width: 60%;*/
      margin-left: 20%;
      margin-right: 20%;
      }
      #rangeInput {
      width: 900px;
      
              }
              span.legend-dot {
 display: inline-block;
 width: 10px;
 height: 10px;
 border-radius: 20px;
 background: #eee;
 margin-right: 0.5em;
 opacity: 0.5;
}

.legend-dot.i4 {
 background: #d95f02;
}
.legend-dot.t4 {
 background: #7570b3;
}
.legend-dot.y4 {
 background: #1b9e77;
}
.legend-dot.o4 {
 background: hsl(329, 70%, 63%);
}
.legend-dot.n4 {
 background: hsl(66, 10%, 47%);
 width: 6px;
 height: 6px;
 margin-left:2px;
}

    </style>
</head>
<body>

<div id='map'></div>
<!-- <div id="range">
<input id="rangeInput" type="range" min="2010" max="2014" step="1" value="2010" />
</div> -->
<div class='sidebar pin-topright z10 pad1'>
    <div class='sidebar-inner fill-white  round pad2y'>

      <header class='pad2x space-bottom1'>
     <!--  <div class="top pad1 fill-blue dark"> -->
<h3  style='display:inline; margin-right: 10px'>US Crash Data 2010-2014</h3>
<p>
</br>
<label>Select a year to review: </label>
  <select id='year' name="year">
    <option value="0">All</option>
    <option value="2010">2010</option>
    <option value="2011">2011</option>
    <option value="2012">2012</option>
    <option value="2013">2013</option>
    <option value="2014">2014</option>
  </select>

  </p>
  <p id='count'>
  
  </p>
       <!-- <ul>
       <li><span class="legend-dot i4"></span>Four Way Intersection</li>
       <li><span class="legend-dot t4"></span>T Intersection</li>
       <li><span class="legend-dot y4"></span>Y Intersection</li>
       <li><span class="legend-dot o4"></span>Other Intersection Types</li>
       <li><span class="legend-dot n4"></span>Not an Intersection</li>
       </ul> -->
      </header>
    </div>
  </div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoicmFteWFyYWd1cGF0aHkiLCJhIjoiOHRoa2JJTSJ9.6Y38XMOQL80LZyrUAjXgIg';
var map = new mapboxgl.Map({
    container: 'map', 
    style: 'mapbox://styles/mapbox/dark-v9', 
    center: [-122.396295, 37.797766], // SF NE Quadrant
    zoom: 13, 
    minZoom:4,
    hash:true
});
map.on('load', function (){
    map.addSource('fars2010-14', {
        type: 'vector',
        url: 'mapbox://ramyaragupathy.41t53t5f'
    });
    map.addLayer({
            "id": "2010-14Base",
            "type": "circle",
            "source": "fars2010-14",
            "source-layer": "2010-14NewTiles-b9df2s",
            "interactive": true,
            "layout": {
                "visibility": "visible"
            },
            "paint": {
                "circle-color": "#ff5b42",
                "circle-radius": {
                    "base": 1,
                    "stops": [
                        [
                            4,
                            1.5
                        ],
                        [
                            13,
                            5
                        ],
                        [
                            16,
                            16
                        ]
                    ]
                },
                "circle-opacity": {
                    "base": 1,
                    "stops": [
                        [
                            5,
                            0.2
                        ],
                        [
                            15,
                            0.8
                        ]
                    ]
                }
            }
        });
 map.addLayer({
            "id": "2010-14Drunk",
            "type": "symbol",
            "source": "fars2010-14",
            "source-layer": "2010-14NewTiles-b9df2s",
            "interactive": true,
            "filter": [
                "!=",
                "drunk driver",
                0
            ],
            "layout": {
                "icon-image": "bar-15",
                "icon-size": {
                    "base": 1,
                    "stops": [
                        [
                            13,
                            0.4
                        ],
                        [
                            16,
                            1
                        ]
                    ]
                },
                "icon-offset": {
                    "base": 1,
                    "stops": [
                        [
                            0,
                            [
                                0,
                                0
                            ]
                        ],
                        [
                            13,
                            [
                                8,
                                0
                            ]
                        ],
                        [
                            16,
                            [
                                20,
                                0
                            ]
                        ]
                    ]
                }
            },
            "paint": {
                "icon-opacity": {
                    "base": 1,
                    "stops": [
                        [
                            12.9,
                            0
                        ],
                        [
                            13,
                            0.8
                        ]
                    ]
                }
            }
        });
map.addLayer({
            "id": "2010-14Speed",
            "type": "symbol",
            "source": "fars2010-14",
            "source-layer": "2010-14NewTiles-b9df2s",
            "interactive": true,
            "filter": [
                "in",
                "speed related",
                "Exceeded speed limit",
                "Yes",
                "Yes specifics unknown",
                "Yes, Racing",
                "Yes, too fast for conditions"
            ],
            "layout": {
                "icon-image": "amusement-park-15",
                "icon-size": {
                    "base": 1,
                    "stops": [
                        [
                            13,
                            0.4
                        ],
                        [
                            16,
                            1
                        ]
                    ]
                },
                "icon-offset": {
                    "base": 1,
                    "stops": [
                        [
                            0,
                            [
                                0,
                                0
                            ]
                        ],
                        [
                            13,
                            [
                                8,
                                8
                            ]
                        ],
                        [
                            16,
                            [
                                20,
                                10
                            ]
                        ]
                    ]
                }
            },
            "paint": {
                "icon-opacity": {
                    "base": 1,
                    "stops": [
                        [
                            12.9,
                            0
                        ],
                        [
                            13,
                            0.8
                        ]
                    ]
                }
            }
        });
map.addLayer({
            "id": "2010-14Pedestrian",
            "type": "symbol",
            "source": "fars2010-14",
            "source-layer": "2010-14NewTiles-b9df2s",
            "interactive": true,
            "filter": [
                "in",
                "Pedestrian",
                "Died En Route",
                "Died at Scene",
                "yes"
            ],
            "layout": {
                "icon-offset": {
                    "base": 1,
                    "stops": [
                        [
                            0,
                            [
                                0,
                                0
                            ]
                        ],
                        [
                            13,
                            [
                                -8,
                                0
                            ]
                        ],
                        [
                            16,
                            [
                                -20,
                                0
                            ]
                        ]
                    ]
                },
                "icon-size": {
                    "base": 1,
                    "stops": [
                        [
                            13,
                            0.8
                        ],
                        [
                            16,
                            1.2
                        ]
                    ]
                },
                "visibility": "visible",
                "icon-image": "star-15"
            },
            "paint": {
                "icon-opacity": {
                    "base": 1,
                    "stops": [
                        [
                            12.9,
                            0
                        ],
                        [
                            13,
                            0.8
                        ]
                    ]
                }
            }
        });
map.addLayer({
            "id": "2010-14Bicyclist",
            "type": "symbol",
            "source": "fars2010-14",
            "source-layer": "2010-14NewTiles-b9df2s",
            "interactive": true,
            "filter": [
                "in",
                "Bicyclist",
                "Died En Route",
                "Died at Scene",
                "yes"
            ],
            "layout": {
                "icon-offset": {
                    "base": 1,
                    "stops": [
                        [
                            0,
                            [
                                0,
                                0
                            ]
                        ],
                        [
                            13,
                            [
                                -8,
                                5
                            ]
                        ],
                        [
                            16,
                            [
                                -20,
                                5
                            ]
                        ]
                    ]
                },
                "icon-size": {
                    "base": 1,
                    "stops": [
                        [
                            13,
                            0.5
                        ],
                        [
                            16,
                            1.3
                        ]
                    ]
                },
                "visibility": "visible",
                "icon-image": "bicycle-15"
            },
            "paint": {
                "icon-opacity": {
                    "base": 1,
                    "stops": [
                        [
                            12.9,
                            0
                        ],
                        [
                            13,
                            0.8
                        ]
                    ]
                }
            }
        });
getFeatureCount(document.getElementById('year').value);
});
document.getElementById('year').addEventListener('change', function(e) {

      var value = this.value;
      console.log(value);
      if (value == 0){
        console.log('all years');
        map.setFilter('2010-14Base', ['in', 'year', 2010,2011,2012,2013,2014]);
      map.setFilter('2010-14Drunk', ['all',['>','drunk driver','0']]);
      map.setFilter('2010-14Speed', ['all',['in','speed related','Exceeded speed limit','Yes','Yes specifics unknown','Yes, Racing','Yes, too fast for conditions']]);
      map.setFilter('2010-14Pedestrian', ['all',['in','Pedestrian','Died En Route','Died at Scene','yes']]);
      map.setFilter('2010-14Bicyclist', ['all',['in','Bicyclist','Died En Route','Died at Scene','yes']]);

      } 
      else {
        map.setFilter('2010-14Base', ['==', 'year', parseInt(value)]);
      map.setFilter('2010-14Drunk', ['all',['>','drunk driver','0'],['==', 'year', parseInt(value)]]);
      map.setFilter('2010-14Speed', ['all',['in','speed related','Exceeded speed limit','Yes','Yes specifics unknown','Yes, Racing','Yes, too fast for conditions'],['==', 'year', parseInt(value)]]);
      map.setFilter('2010-14Pedestrian', ['all',['in','Pedestrian','Died En Route','Died at Scene','yes'],['==', 'year', parseInt(value)]]);
      map.setFilter('2010-14Bicyclist', ['all',['in','Bicyclist','Died En Route','Died at Scene','yes'],['==', 'year', parseInt(value)]]);
      }
     
     
     getFeatureCount(parseInt(value));
      
});


function getFeatureCount(value){
    var pedestrianCount = 0;
    var bicyclistCount =0;

    var bounds = map.getBounds();
    var bbox = [bounds._sw.lng,bounds._sw.lat,bounds._ne.lng,bounds._ne.lat,];
    var poly = turf.bboxPolygon(bbox);
if (value == 0)
{
    var yearFilter = ['in','year',2010,2011,2012,2013,2014]
}
else{
    var yearFilter = ['==','year',value];
}
    var featuresInTile = map.querySourceFeatures('fars2010-14', {sourceLayer: '2010-14NewTiles-b9df2s',


filter:yearFilter });
    console.log('rendered features for '+ value +' '+featuresInTile.length);
console.log(JSON.stringify(turf.featureCollection(featuresInTile)));
console.log(JSON.stringify(turf.featureCollection([poly])));
   


    var featuresInBuffer = turf.within(turf.featureCollection(featuresInTile), turf.featureCollection([poly]));
    console.log(featuresInBuffer.features.length);
    featuresInBuffer.features.forEach(function(item){
    if (item.properties.Pedestrian){
        pedestrianCount++;
    }
    if(item.properties.Bicyclist){

        bicyclistCount++;
    }

    var countSummary ='Total number of accidents: '+ featuresInBuffer.features.length+ '</br>'+'Pedestrians involved: '+ pedestrianCount+'</br>'+'Cyclists involved: '+bicyclistCount;
    console.log(countSummary);
    document.getElementById('count').innerHTML = countSummary;


    });


}



map.on('dragend', function (e) {
    console.log('dragend');
    getFeatureCount(document.getElementById('year').value);
        
        
    });

</script>

</body>
</html>